version: "3.9"
services:
  mongo:
    image: mongo:latest
    ports:
      - '8080:27017'
    command: ["mongod", "--syslog"]
    
  redis:
    image: redis:latest

  auth: 
    build:
      context: ./auth
      dockerfile: Dockerfile
    env_file:
      - ./auth/.env
    environment: 
      - MONGO_URI=mongodb://mongo:27017/
      - REDIS_HOST=redis://redis:6379
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 1s
      restart_policy:
        condition: on-failure
        delay: 2s
    depends_on:
      - mongo
      - redis
    
  copyrights: 
    build:
      context: ./copyrights
      dockerfile: Dockerfile
    env_file:
      - ./copyrights/.env
    environment: 
      - MONGO_URI=mongodb://mongo:27017/
      - REDIS_HOST=redis://redis:6379
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 1s
      restart_policy:
        condition: on-failure
        delay: 10s
    develop:
      watch:
        - action: sync+restart
          path: ./copyrights
          target: /app
          ignore:
            - node_modules/
            - package-lock.json
            - yarn.lock
    depends_on:
      - mongo
      - redis
      
  nginx:
    image: nginx:stable-alpine
    ports:
      - '3000:80'
    volumes:
      - ./nginx/copyrights.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - auth 
      - copyrights

